<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Globale - Salaire et Retraite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .container {
            max-width: 800px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 50px;
            margin-bottom: 50px;
        }
        #totalCostInput {
            text-align: right;
            width: 200px;
        }
        .disclaimer {
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="alert alert-info disclaimer mb-4">
            Les calculs présentés sont à titre indicatif dans le cas d'une SARL. Les résultats peuvent varier en fonction de votre situation personnelle et fiscale. Le calcul de l'imposition est réalisé sur une base simplifiée d'une personne célibataire sans enfant afin de montrer les impacts de l'imposition. <strong>Attention</strong> : pour les SARL, les dividendes dépassant 10% du capital social sont soumis aux cotisations sociales qui ne sont pas modélisées dans ce calcul.
        </div>
        <h1 class="mb-4">Analyse Globale - Salaire et Retraite</h1>
        <form id="analysisForm">
            <div class="mb-3">
                <label for="totalCostInput" class="form-label">Coût total disponible pour la rémunération :</label>
                <div class="d-flex align-items-center">
                    <input type="text" id="totalCostInput" class="form-control me-2" required>
                    <button type="submit" class="btn btn-primary" id="analyzeButton">Analyser</button>
                </div>
            </div>
        </form>
        
        <div id="result" class="mt-4" style="display: none;">
            <h2>Résultats de l'analyse</h2>
            <canvas id="globalAnalysisChart"></canvas>
            <div id="bestOption" class="mt-4"></div>
        </div>
        <div id="loading" class="mt-4" style="display: none;">
            <p>Analyse en cours, veuillez patienter...</p>
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
        </div>
        <div id="error" class="mt-4 alert alert-danger" style="display: none;"></div>
    </div>

    <script>
        let chart;

        $(document).ready(function() {
            $('#totalCostInput').on('input', function() {
                let value = $(this).val().replace(/[^0-9]/g, '');
                if (value) {
                    value = parseInt(value, 10);
                    $(this).val(value.toLocaleString('fr-FR') + ' €');
                }
            });

            $('#analysisForm').on('submit', function(e) {
                e.preventDefault();
                const totalCost = parseInt($('#totalCostInput').val().replace(/[^0-9]/g, ''));
                $('#loading').show();
                $('#result').hide();
                $('#error').hide();
                analyzeGlobal(totalCost);
            });
        });

        function analyzeGlobal(totalCost) {
            const apiUrl = 'https://mon-entreprise.urssaf.fr/api/v1/evaluate';
            const results = [];
            const delay = 500; // 500ms delay between calls

            function makeApiCall(dividends) {
                const salary = totalCost - dividends;
                if (salary < 10000) {
                    displayResults(results, totalCost);
                    return;
                }

                const salaryData = {
                    "expressions": [
                        "dirigeant . rémunération . net . après impôt",
                        "impôt . revenu imposable",
                        "protection sociale . retraite . base",
                        "protection sociale . retraite . complémentaire . RCI"
                    ],
                    "situation": {
                        "entreprise . imposition": "'IS'",
                        "entreprise . associés": "'unique'",
                        "entreprise . catégorie juridique": "'SARL'",
                        "dirigeant . rémunération . totale": salary
                    }
                };

                $.ajax({
                    url: apiUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(salaryData)
                }).done(function(salaryResponse) {
                    const netSalaryAfterTax = salaryResponse.evaluate[0].nodeValue;
                    const taxableIncome = salaryResponse.evaluate[1].nodeValue;
                    const baseRetirementMonthlyAmount = salaryResponse.evaluate[2].nodeValue;
                    const complementaryRetirementAmount = salaryResponse.evaluate[3].nodeValue * 43;

                    const corporateTax = calculateCorporateTax(dividends);
                    const grossDividends = dividends - corporateTax;
                    const netDividendsPFU = calculateNetDividendsPFU(grossDividends);
                    const totalNetAfterTaxPFU = netSalaryAfterTax + netDividendsPFU;

                    const dividendData = {
                        "expressions": ["bénéficiaire . dividendes . nets d'impôt"],
                        "situation": {
                            "impôt . foyer fiscal . revenu imposable . autres revenus imposables": taxableIncome,
                            "impôt . méthode de calcul": "'barème standard'",
                            "dirigeant . rémunération . net . imposable": "0 €/an",
                            "bénéficiaire": "oui",
                            "entreprise . catégorie juridique": "'SAS'",
                            "bénéficiaire . dividendes . bruts": grossDividends
                        }
                    };

                    $.ajax({
                        url: apiUrl,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(dividendData)
                    }).done(function(dividendResponse) {
                        const netDividendsProgressive = dividendResponse.evaluate[0].nodeValue;
                        const totalNetAfterTaxProgressive = netSalaryAfterTax + netDividendsProgressive;

                        results.push({
                            salary: salary,
                            dividends: dividends,
                            netSalaryAfterTax: netSalaryAfterTax,
                            netDividendsPFU: netDividendsPFU,
                            netDividendsProgressive: netDividendsProgressive,
                            totalNetAfterTaxPFU: totalNetAfterTaxPFU,
                            totalNetAfterTaxProgressive: totalNetAfterTaxProgressive,
                            baseRetirementYearlyAmount: baseRetirementMonthlyAmount * 12,
                            complementaryRetirementAmount: complementaryRetirementAmount,
                            totalRetirement: baseRetirementMonthlyAmount * 12 + complementaryRetirementAmount
                        });

                        // Update progress
                        const progress = Math.round((dividends / totalCost) * 100);
                        $('#progressBar').css('width', progress + '%').attr('aria-valuenow', progress).text(progress + '%');

                        // Make the next call after a delay
                        setTimeout(() => makeApiCall(dividends + 10000), delay);
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error('Dividend API call failed:', textStatus, errorThrown);
                        $('#loading').hide();
                        $('#error').show().text('Une erreur est survenue lors de l\'analyse des dividendes. Veuillez réessayer plus tard.');
                    });
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Salary API call failed:', textStatus, errorThrown);
                    $('#loading').hide();
                    $('#error').show().text('Une erreur est survenue lors de l\'analyse du salaire. Veuillez réessayer plus tard.');
                });
            }

            // Start the API calls from 0€ dividends
            $('#loading').show();
            $('#result').hide();
            $('#error').hide();
            makeApiCall(0);
        }

        function calculateCorporateTax(profit) {
            if (profit <= 42500) {
                return profit * 0.15;
            } else {
                return 42500 * 0.15 + (profit - 42500) * 0.25;
            }
        }

        function calculateNetDividendsPFU(grossDividends) {
            const socialCharges = grossDividends * 0.172; // 17.2% social charges
            const flatTax = grossDividends * 0.128; // 12.8% flat tax on gross amount
            return grossDividends - socialCharges - flatTax;
        }

        function displayResults(results, totalCost) {
            const labels = results.map(r => r.salary.toLocaleString('fr-FR') + ' €');

            // Destroy existing chart if it exists
            if (chart) chart.destroy();

            // Create the global analysis chart
            const ctx = document.getElementById('globalAnalysisChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Meilleur total net après impôt',
                        data: results.map(r => Math.max(r.totalNetAfterTaxPFU, r.totalNetAfterTaxProgressive)),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'Total droits à la retraite',
                        data: results.map(r => r.totalRetirement),
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Montant en euros'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Salaire brut'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Salaire brut: ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
                                    }
                                    return label;
                                },
                                afterBody: function(tooltipItems) {
                                    const dataIndex = tooltipItems[0].dataIndex;
                                    const data = results[dataIndex];
                                    const bestOption = data.totalNetAfterTaxPFU > data.totalNetAfterTaxProgressive ? 'PFU' : 'Barème Progressif';
                                    return [
                                        '',
                                        'Meilleure option: ' + bestOption,
                                        'Total net après impôt (PFU): ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(data.totalNetAfterTaxPFU),
                                        'Total net après impôt (Progressif): ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(data.totalNetAfterTaxProgressive),
                                        'Montant alloué au salaire: ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(data.salary),
                                        'Montant alloué aux dividendes: ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(data.dividends),
                                        'Retraite base: ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(data.baseRetirementYearlyAmount),
                                        'Retraite complémentaire: ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(data.complementaryRetirementAmount)
                                    ];
                                }
                            }
                        }
                    }
                }
            });

            const bestOption = results.reduce((prev, current) => 
                (Math.max(prev.totalNetAfterTaxPFU, prev.totalNetAfterTaxProgressive) > Math.max(current.totalNetAfterTaxPFU, current.totalNetAfterTaxProgressive)) ? prev : current
            );

            $('#bestOption').html(`
                <h3>Meilleure option globale</h3>
                <p>Salaire brut : ${bestOption.salary.toLocaleString('fr-FR')} €/an</p>
                <p>Dividendes : ${bestOption.dividends.toLocaleString('fr-FR')} €/an</p>
                <p>Meilleure option fiscale : ${bestOption.totalNetAfterTaxPFU > bestOption.totalNetAfterTaxProgressive ? 'PFU' : 'Barème Progressif'}</p>
                <p>Total net après impôt : ${Math.round(Math.max(bestOption.totalNetAfterTaxPFU, bestOption.totalNetAfterTaxProgressive)).toLocaleString('fr-FR')} €/an</p>
                <p>Total droits à la retraite : ${Math.round(bestOption.totalRetirement).toLocaleString('fr-FR')} €/an</p>
            `);

            $('#result').show();
            $('#loading').hide();
        }
    </script>
</body>
</html>