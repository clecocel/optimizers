<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur avancé de rémunération du dirigeant (SAS)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .container {
            max-width: 800px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 50px;
            margin-bottom: 50px;
        }
        #totalCostInput {
            text-align: right;
            width: 200px;
        }
        .disclaimer {
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="alert alert-info disclaimer mb-4">
            Les calculs présentés sont à titre indicatif dans le cas d'une SAS. Les résultats peuvent varier en fonction de votre situation personnelle et fiscale. Le calcul de l'imposition est réalisé sur une base simplifiée d'une personne célibataire sans enfant afin de montrer les impacts de l'imposition.
        </div>
        <h1 class="mb-4">Simulateur avancé de rémunération du dirigeant (SAS)</h1>
        <form id="advancedForm">
            <div class="mb-3">
                <label for="totalCostInput" class="form-label">Coût total disponible pour la rémunération :</label>
                <div class="d-flex align-items-center">
                    <input type="text" id="totalCostInput" class="form-control me-2" required>
                    <button type="submit" class="btn btn-primary" id="analyzeButton">Analyser</button>
                </div>
            </div>
        </form>
        
        <div id="result" class="mt-4" style="display: none;">
            <h2>Résultats de l'analyse</h2>
            <h3>Après impôt</h3>
            <canvas id="optimizationChartAfterTax"></canvas>
            <div id="bestOption" class="mt-4"></div>
        </div>
        <div id="loading" class="mt-4" style="display: none;">
            <p>Analyse en cours, veuillez patienter...</p>
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
        </div>
        <div id="error" class="mt-4 alert alert-danger" style="display: none;"></div>
    </div>

    <script>
        let chart;

        $(document).ready(function() {
            $('#totalCostInput').on('input', function() {
                let value = $(this).val().replace(/[^0-9]/g, '');
                if (value) {
                    value = parseInt(value, 10);
                    $(this).val(value.toLocaleString('fr-FR') + ' €');
                }
            });

            $('#advancedForm').on('submit', function(e) {
                e.preventDefault();
                const totalCost = parseInt($('#totalCostInput').val().replace(/[^0-9]/g, ''));
                $('#loading').show();
                $('#result').hide();
                $('#error').hide();
                analyzeOptimization(totalCost);
            });
        });

        function analyzeOptimization(totalCost) {
            const apiUrl = 'https://mon-entreprise.urssaf.fr/api/v1/evaluate';
            const results = [];
            const delay = 500; // 500ms delay between calls

            function makeApiCall(dividends) {
                const salary = totalCost - dividends;
                if (salary < 10000) {
                    displayResults(results, totalCost);
                    return;
                }

                const salaryData = {
                    "expressions": [
                        "salarié . rémunération . net . payé après impôt",
                        "impôt . revenu imposable",
                        "protection sociale . retraite . base",
                        "protection sociale . retraite . complémentaire"
                    ],
                    "situation": {
                        "dirigeant . rémunération . totale": salary,
                        "entreprise . catégorie juridique": "'SAS'"
                    }
                };

                $.ajax({
                    url: apiUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(salaryData)
                }).done(function(salaryResponse) {
                    const netSalary = salaryResponse.evaluate[0].nodeValue * 12; // Convert monthly to yearly
                    const taxableIncome = salaryResponse.evaluate[1].nodeValue * 12; // Convert monthly to yearly
                    const baseRetirementMonthlyAmount = salaryResponse.evaluate[2].nodeValue;
                    const complementaryRetirementAmount = salaryResponse.evaluate[3].nodeValue * 4.3 * 12; // Convert to yearly amount for 43 years

                    const corporateTax = calculateCorporateTax(dividends);
                    const grossDividends = dividends - corporateTax;
                    const netDividendsPFU = calculateNetDividendsPFU(grossDividends);
                    const totalNetAfterTaxPFU = netSalary + netDividendsPFU;

                    const dividendData = {
                        "expressions": ["bénéficiaire . dividendes . nets d'impôt"],
                        "situation": {
                            "impôt . foyer fiscal . revenu imposable . autres revenus imposables": taxableIncome,
                            "impôt . méthode de calcul": "'barème standard'",
                            "dirigeant . rémunération . net . imposable": "0 €/an",
                            "bénéficiaire": "oui",
                            "entreprise . catégorie juridique": "'SAS'",
                            "bénéficiaire . dividendes . bruts": grossDividends
                        }
                    };

                    $.ajax({
                        url: apiUrl,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(dividendData)
                    }).done(function(dividendResponse) {
                        const netDividendsProgressive = dividendResponse.evaluate[0].nodeValue;
                        const totalNetAfterTaxProgressive = netSalary + netDividendsProgressive;

                        results.push({
                            salary: salary,
                            dividends: dividends,
                            netSalary: netSalary,
                            netDividendsPFU: netDividendsPFU,
                            netDividendsProgressive: netDividendsProgressive,
                            totalNetAfterTaxPFU: totalNetAfterTaxPFU,
                            totalNetAfterTaxProgressive: totalNetAfterTaxProgressive,
                            baseRetirementYearlyAmount: baseRetirementMonthlyAmount * 12,
                            complementaryRetirementAmount: complementaryRetirementAmount
                        });

                        // Update progress
                        const progress = Math.round((dividends / totalCost) * 100);
                        $('#progressBar').css('width', progress + '%').attr('aria-valuenow', progress).text(progress + '%');

                        // Make the next call after a delay
                        setTimeout(() => makeApiCall(dividends + 10000), delay);
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error('Dividend API call failed:', textStatus, errorThrown);
                        $('#loading').hide();
                        $('#error').show().text('Une erreur est survenue lors de l\'analyse des dividendes. Veuillez réessayer plus tard.');
                    });
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Salary API call failed:', textStatus, errorThrown);
                    $('#loading').hide();
                    $('#error').show().text('Une erreur est survenue lors de l\'analyse du salaire. Veuillez réessayer plus tard.');
                });
            }

            // Start the API calls from 0€ dividends
            $('#loading').show();
            $('#result').hide();
            $('#error').hide();
            makeApiCall(0);
        }

        function calculateCorporateTax(profit) {
            if (profit <= 42500) {
                return profit * 0.15;
            } else {
                return 42500 * 0.15 + (profit - 42500) * 0.25;
            }
        }

        function calculateNetDividendsPFU(grossDividends) {
            const socialCharges = grossDividends * 0.172; // 17.2% social charges
            const flatTax = grossDividends * 0.128; // 12.8% flat tax on gross amount
            return grossDividends - socialCharges - flatTax;
        }

        function displayResults(results, totalCost) {
            console.log('Results:', results);

            const labels = results.map(r => r.salary.toLocaleString('fr-FR') + ' €');

            // Destroy existing chart if it exists
            if (chart) chart.destroy();

            // Create the after-tax chart
            const ctxAfterTax = document.getElementById('optimizationChartAfterTax').getContext('2d');
            chart = new Chart(ctxAfterTax, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Salaire net après impôt',
                        data: results.map(r => r.netSalary),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'Dividendes nets après impôt (PFU)',
                        data: results.map(r => r.netDividendsPFU),
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }, {
                        label: 'Dividendes nets après impôt (Progressif)',
                        data: results.map(r => r.netDividendsProgressive),
                        borderColor: 'rgb(255, 159, 64)',
                        tension: 0.1
                    }, {
                        label: 'Total net après impôt (PFU)',
                        data: results.map(r => r.totalNetAfterTaxPFU),
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1
                    }, {
                        label: 'Total net après impôt (Progressif)',
                        data: results.map(r => r.totalNetAfterTaxProgressive),
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Montant en euros'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Montant alloué salaire'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Montant alloué salaire : ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
                                    }
                                    return label;
                                },
                                afterBody: function(tooltipItems) {
                                    const dataIndex = tooltipItems[0].dataIndex;
                                    const salary = results[dataIndex].salary;
                                    const dividends = results[dataIndex].dividends;
                                    const corporateTax = calculateCorporateTax(dividends);
                                    const grossDividends = dividends - corporateTax;
                                    return [
                                        '',
                                        'Montant alloué au salaire: ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(salary),
                                        'Montant alloué aux dividendes: ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(dividends),
                                        'Impôt sur les sociétés: ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(corporateTax),
                                        'Dividendes bruts (après IS): ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(grossDividends)
                                    ];
                                }
                            }
                        }
                    }
                }
            });

            chart.update();

            const bestOptionPFU = results.reduce((prev, current) => 
                (prev.totalNetAfterTaxPFU > current.totalNetAfterTaxPFU) ? prev : current
            );

            const bestOptionProgressive = results.reduce((prev, current) => 
                (prev.totalNetAfterTaxProgressive > current.totalNetAfterTaxProgressive) ? prev : current
            );

            $('#bestOption').html(`
                <h3>Meilleures options après impôt</h3>
                <h4>Avec PFU (Prélèvement Forfaitaire Unique)</h4>
                <p>Montant alloué au salaire : ${bestOptionPFU.salary.toLocaleString('fr-FR')} €</p>
                <p>Montant alloué aux dividendes : ${bestOptionPFU.dividends.toLocaleString('fr-FR')} €</p>
                <p>Salaire net après impôt : ${Math.round(bestOptionPFU.netSalary).toLocaleString('fr-FR')} €</p>
                <p>Dividendes nets après impôt : ${Math.round(bestOptionPFU.netDividendsPFU).toLocaleString('fr-FR')} €</p>
                <p>Total net après impôt : ${Math.round(bestOptionPFU.totalNetAfterTaxPFU).toLocaleString('fr-FR')} €</p>
                <p>Retraite base : ${Math.round(bestOptionPFU.baseRetirementYearlyAmount).toLocaleString('fr-FR')} €/an</p>
                <p>Retraite complémentaire : ${Math.round(bestOptionPFU.complementaryRetirementAmount).toLocaleString('fr-FR')} €/an</p>
                <h4>Avec Barème Progressif</h4>
                <p>Montant alloué au salaire : ${bestOptionProgressive.salary.toLocaleString('fr-FR')} €</p>
                <p>Montant alloué aux dividendes : ${bestOptionProgressive.dividends.toLocaleString('fr-FR')} €</p>
                <p>Salaire net après impôt : ${Math.round(bestOptionProgressive.netSalary).toLocaleString('fr-FR')} €</p>
                <p>Dividendes nets après impôt : ${Math.round(bestOptionProgressive.netDividendsProgressive).toLocaleString('fr-FR')} €</p>
                <p>Total net après impôt : ${Math.round(bestOptionProgressive.totalNetAfterTaxProgressive).toLocaleString('fr-FR')} €</p>
                <p>Retraite base : ${Math.round(bestOptionProgressive.baseRetirementYearlyAmount).toLocaleString('fr-FR')} €/an</p>
                <p>Retraite complémentaire : ${Math.round(bestOptionProgressive.complementaryRetirementAmount).toLocaleString('fr-FR')} €/an</p>
                <p>Meilleure option fiscale : ${bestOptionPFU.totalNetAfterTaxPFU > bestOptionProgressive.totalNetAfterTaxProgressive ? 'PFU' : 'Barème Progressif'}</p>
`);
            $('#result').show();
            $('#loading').hide();
        }
    </script>
</body>
</html>